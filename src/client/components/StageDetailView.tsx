import React, { useState } from 'react';
import {
    Card,
    Typography,
    Button,
    Input,
    InputNumber,
    Alert,
    Spin,
    message,
    Space,
    Divider,
    Progress,
    List,
    Tag
} from 'antd';
import { PlayCircleOutlined, EditOutlined, StopOutlined, ExportOutlined } from '@ant-design/icons';
import { OutlineExportModal } from './shared/OutlineExportModal';
import { formatEpisodesForExport, type EpisodeExportData } from '../utils/episodeExporter';
import { useEpisodeContext } from '../contexts/EpisodeContext';

const { Title, Text, Paragraph } = Typography;
const { TextArea } = Input;

interface StageDetailViewProps {
    scriptId: string;
    stageId: string | null;
    selectedEpisodeId?: string | null;
}

export const StageDetailView: React.FC<StageDetailViewProps> = ({
    scriptId,
    stageId,
    selectedEpisodeId
}) => {
    const { state, actions } = useEpisodeContext();
    const [editMode, setEditMode] = useState(false);
    const [isExportModalVisible, setIsExportModalVisible] = useState(false);
    const [exportText, setExportText] = useState('');

    // Editable parameters
    const [editedEpisodes, setEditedEpisodes] = useState<number>(0);
    const [editedRequirements, setEditedRequirements] = useState<string>('');

    // Get current stage data and episode data
    const stageData = state.stages.find(s => s.artifactId === stageId);
    const stageEpisodeData = stageId ? state.stageEpisodeData[stageId] : undefined;
    const episodes = stageEpisodeData?.episodes || [];
    const isLoading = stageEpisodeData?.loading || false;
    const isStreaming = stageEpisodeData?.isStreaming || false;
    const sessionData = stageEpisodeData?.sessionData;

    // üî• DEBUG: Log stage data to see what fields are available
    React.useEffect(() => {
        if (stageData) {
            console.log('üîç StageDetailView - Current stage data:', stageData);
            console.log('üîç Available fields:', Object.keys(stageData));
            console.log('üîç keyPoints:', stageData.keyPoints);
            console.log('üîç timeframe:', stageData.timeframe);
            console.log('üîç Enhanced fields present:', {
                hasKeyPoints: !!stageData.keyPoints,
                hasTimeframe: !!stageData.timeframe,
                hasStartingCondition: !!stageData.startingCondition,
                hasEndingCondition: !!stageData.endingCondition,
                hasStageStartEvent: !!stageData.stageStartEvent,
                hasStageEndEvent: !!stageData.stageEndEvent,
                hasExternalPressure: !!stageData.externalPressure
            });
        }
    }, [stageData]);

    // üî• NEW: Debug episode data to see if new fields are present
    React.useEffect(() => {
        if (episodes.length > 0) {
            console.log('üîç StageDetailView - Episodes data:', episodes);
            console.log('üîç First episode structure:', episodes[0]);
            console.log('üîç Episode fields available:', Object.keys(episodes[0]));
            console.log('üîç Enhanced episode fields present:', {
                hasEmotionDevelopments: !!episodes[0].emotionDevelopments,
                hasRelationshipDevelopments: !!episodes[0].relationshipDevelopments,
                emotionDevelopmentsLength: episodes[0].emotionDevelopments?.length || 0,
                relationshipDevelopmentsLength: episodes[0].relationshipDevelopments?.length || 0
            });
        }
    }, [episodes]);

    // Check if this stage is currently streaming
    const isActiveStreaming = state.activeStreamingStageId === stageId;

    // Find selected episode if selectedEpisodeId is provided
    const selectedEpisode = selectedEpisodeId ?
        episodes.find(ep => ep.episodeNumber.toString() === selectedEpisodeId) : null;

    // Initialize editable parameters when stage data loads
    React.useEffect(() => {
        if (stageData) {
            setEditedEpisodes(stageData.numberOfEpisodes);
        }
    }, [stageData]);

    const handleStartGeneration = async () => {
        if (!stageData) return;

        try {
            await actions.startEpisodeGeneration(stageData.artifactId, editedEpisodes, editedRequirements.trim() || undefined);
            message.success('ÂâßÈõÜÁîüÊàêÂ∑≤ÂºÄÂßã');
        } catch (error) {
            console.error('Error starting episode generation:', error);
            message.error('ÂêØÂä®ÂâßÈõÜÁîüÊàêÂ§±Ë¥•');
        }
    };

    const handleStopGeneration = async () => {
        if (!stageData) return;

        try {
            await actions.stopEpisodeGeneration(stageData.artifactId);
            message.success('ÂâßÈõÜÁîüÊàêÂ∑≤ÂÅúÊ≠¢');
        } catch (error) {
            console.error('Error stopping episode generation:', error);
            message.error('ÂÅúÊ≠¢ÂâßÈõÜÁîüÊàêÂ§±Ë¥•');
        }
    };

    const handleSaveParameters = () => {
        setEditMode(false);
        message.success('ÂèÇÊï∞Â∑≤‰øùÂ≠ò');
    };

    const handleExport = () => {
        if (!stageData) return;

        // Prepare export data
        const exportData: EpisodeExportData = {
            sessionId: sessionData?.session.id || 'unknown',
            stageData: {
                stageNumber: stageData.stageNumber,
                stageSynopsis: stageData.stageSynopsis,
                numberOfEpisodes: stageData.numberOfEpisodes,
                artifactId: stageData.artifactId
            },
            episodes,
            generatedAt: new Date().toISOString()
        };

        // Generate formatted text
        const formattedText = formatEpisodesForExport(exportData);
        setExportText(formattedText);
        setIsExportModalVisible(true);
    };

    if (isLoading) {
        return (
            <div style={{ textAlign: 'center', padding: '50px' }}>
                <Spin size="large" />
                <div style={{ marginTop: '16px' }}>
                    <Text>Âä†ËΩΩÈò∂ÊÆµËØ¶ÊÉÖ...</Text>
                </div>
            </div>
        );
    }

    if (!stageId) {
        return (
            <Alert
                message="ËØ∑ÈÄâÊã©Èò∂ÊÆµ"
                description="Âú®Â∑¶‰æßÊ†ëÂΩ¢ËèúÂçï‰∏≠ÈÄâÊã©‰∏Ä‰∏™Èò∂ÊÆµÂºÄÂßãÁîüÊàêÂâßÈõÜ"
                type="info"
                showIcon
            />
        );
    }

    if (!stageData) {
        return (
            <Alert
                message="Êú™ÊâæÂà∞Èò∂ÊÆµÊï∞ÊçÆ"
                description="ËØ∑Ê±ÇÁöÑÈò∂ÊÆµ‰∏çÂ≠òÂú®ÊàñÂ∑≤Ë¢´Âà†Èô§"
                type="error"
                showIcon
            />
        );
    }

    // Calculate expected episodes and progress
    const expectedEpisodes = editedEpisodes || stageData.numberOfEpisodes;
    const progress = Math.min((episodes.length / expectedEpisodes) * 100, 100);

    return (
        <div style={{ padding: '20px' }}>
            {/* Selected Episode Highlight */}
            {selectedEpisode && (
                <Card
                    size="small"
                    style={{
                        marginBottom: '20px',
                        borderColor: '#1890ff',
                        backgroundColor: '#f6ffed'
                    }}
                >
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                        <Tag color="blue">ÈÄâ‰∏≠ÂâßÈõÜ</Tag>
                        <Text strong>Á¨¨{selectedEpisode.episodeNumber}ÈõÜ: {selectedEpisode.title}</Text>
                    </div>
                    <Paragraph style={{ margin: '8px 0 0 0', fontSize: '14px' }}>
                        {selectedEpisode.briefSummary}
                    </Paragraph>
                </Card>
            )}

            {/* Stage Information */}
            <Card title={`Á¨¨${stageData.stageNumber}Èò∂ÊÆµ`} style={{ marginBottom: '20px' }}>
                <Paragraph>{stageData.stageSynopsis}</Paragraph>

                {/* üî• NEW: Enhanced Stage Context Display */}
                {(stageData.timeframe || stageData.startingCondition || stageData.endingCondition) && (
                    <>
                        <Divider />
                        <Title level={5}>Èò∂ÊÆµËÉåÊôØ</Title>
                        <Space direction="vertical" style={{ width: '100%' }}>
                            {stageData.timeframe && (
                                <div>
                                    <Text strong>Êó∂Èó¥Ë∑®Â∫¶Ôºö</Text>
                                    <Text>{stageData.timeframe}</Text>
                                </div>
                            )}
                            {stageData.startingCondition && (
                                <div>
                                    <Text strong>ÂºÄÂßãÁä∂ÊÄÅÔºö</Text>
                                    <Text>{stageData.startingCondition}</Text>
                                </div>
                            )}
                            {stageData.endingCondition && (
                                <div>
                                    <Text strong>ÁªìÊùüÁä∂ÊÄÅÔºö</Text>
                                    <Text>{stageData.endingCondition}</Text>
                                </div>
                            )}
                            {stageData.stageStartEvent && (
                                <div>
                                    <Text strong>Ëµ∑Âßã‰∫ã‰ª∂Ôºö</Text>
                                    <Text>{stageData.stageStartEvent}</Text>
                                </div>
                            )}
                            {stageData.stageEndEvent && (
                                <div>
                                    <Text strong>ÁªìÊùü‰∫ã‰ª∂Ôºö</Text>
                                    <Text>{stageData.stageEndEvent}</Text>
                                </div>
                            )}
                            {stageData.externalPressure && (
                                <div>
                                    <Text strong>Â§ñÈÉ®ÂéãÂäõÔºö</Text>
                                    <Text>{stageData.externalPressure}</Text>
                                </div>
                            )}
                        </Space>
                    </>
                )}

                {/* üî• NEW: Enhanced Key Points Display */}
                {stageData.keyPoints && Array.isArray(stageData.keyPoints) && stageData.keyPoints.length > 0 && (
                    <>
                        <Divider />
                        <Title level={5}>ÂÖ≥ÈîÆÊïÖ‰∫ãËäÇÁÇπÔºàÂ∞Ü‰º†ÈÄíÁªôAIÁîüÊàêÂâßÈõÜÔºâ</Title>
                        <div style={{ marginBottom: '16px' }}>
                            {stageData.keyPoints.map((point: any, index: number) => (
                                <Card 
                                    key={index} 
                                    size="small" 
                                    style={{ 
                                        marginBottom: '12px',
                                        backgroundColor: '#1f1f1f',
                                        borderColor: '#404040'
                                    }}
                                    title={
                                        <div style={{ color: '#e6edf3' }}>
                                            <Text strong style={{ color: '#58a6ff' }}>
                                                ËäÇÁÇπ {index + 1}: {point.event}
                                            </Text>
                                            {point.timeSpan && (
                                                <Tag color="blue" style={{ marginLeft: '8px' }}>
                                                    {point.timeSpan}
                                                </Tag>
                                            )}
                                        </div>
                                    }
                                >
                                    {/* Emotion Arcs */}
                                    {point.emotionArcs && Array.isArray(point.emotionArcs) && point.emotionArcs.length > 0 && (
                                        <div style={{ marginBottom: '12px' }}>
                                            <Text strong style={{ color: '#f85149' }}>ÊÉÖÊÑüÂèëÂ±ïÔºö</Text>
                                            {point.emotionArcs.map((arc: any, arcIndex: number) => (
                                                <div key={arcIndex} style={{ marginLeft: '16px', marginTop: '4px' }}>
                                                    <Text style={{ color: '#e6edf3' }}>
                                                        <Text style={{ color: '#ffa657' }}>
                                                            {Array.isArray(arc.characters) ? arc.characters.join('„ÄÅ') : arc.characters}
                                                        </Text>
                                                        : {arc.content}
                                                    </Text>
                                                </div>
                                            ))}
                                        </div>
                                    )}

                                    {/* Relationship Developments */}
                                    {point.relationshipDevelopments && Array.isArray(point.relationshipDevelopments) && point.relationshipDevelopments.length > 0 && (
                                        <div>
                                            <Text strong style={{ color: '#a5f3fc' }}>ÂÖ≥Á≥ªÂèëÂ±ïÔºö</Text>
                                            {point.relationshipDevelopments.map((rel: any, relIndex: number) => (
                                                <div key={relIndex} style={{ marginLeft: '16px', marginTop: '4px' }}>
                                                    <Text style={{ color: '#e6edf3' }}>
                                                        <Text style={{ color: '#ffa657' }}>
                                                            {Array.isArray(rel.characters) ? rel.characters.join('„ÄÅ') : rel.characters}
                                                        </Text>
                                                        : {rel.content}
                                                    </Text>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </Card>
                            ))}
                        </div>
                        <Alert
                            message="AIÂâßÈõÜÁîüÊàê‰∏ä‰∏ãÊñá"
                            description="‰ª•‰∏äËØ¶ÁªÜÁöÑËßíËâ≤ÊÉÖÊÑüÂèëÂ±ïÂíåÂÖ≥Á≥ªÂèòÂåñ‰ø°ÊÅØÂ∞ÜË¢´‰º†ÈÄíÁªôAIÔºåÁî®‰∫éÁîüÊàêÂÖ∑ÊúâËøûË¥ØÊÄßÂíåÊ∑±Â∫¶ÁöÑÂàÜÈõÜÂâßÊÉÖ„ÄÇËøôÁ°Æ‰øù‰∫ÜÊØèÈõÜÈÉΩËÉΩÊé®ËøõËßíËâ≤ÂèëÂ±ïÂíåÊÉÖÊÑüÁ∫ø„ÄÇ"
                            type="info"
                            showIcon
                            style={{ marginBottom: '16px' }}
                        />
                    </>
                )}

                <Divider />

                {/* Generation Parameters */}
                <div style={{ marginBottom: '20px' }}>
                    <Title level={5}>ÁîüÊàêÂèÇÊï∞</Title>
                    <Space direction="vertical" style={{ width: '100%' }}>
                        <div>
                            <Text strong>ÂâßÈõÜÊï∞Èáè: </Text>
                            {editMode ? (
                                <InputNumber
                                    min={1}
                                    max={20}
                                    value={editedEpisodes}
                                    onChange={value => setEditedEpisodes(value || 1)}
                                />
                            ) : (
                                <Text>{expectedEpisodes}ÈõÜ</Text>
                            )}
                        </div>

                        <div>
                            <Text strong>ÁâπÊÆäË¶ÅÊ±Ç: </Text>
                            {editMode ? (
                                <TextArea
                                    rows={3}
                                    placeholder="ËæìÂÖ•ÂØπÂâßÈõÜÁîüÊàêÁöÑÁâπÊÆäË¶ÅÊ±Ç..."
                                    value={editedRequirements}
                                    onChange={e => setEditedRequirements(e.target.value)}
                                />
                            ) : (
                                <Text style={{ color: '#666' }}>
                                    {editedRequirements || 'Êó†ÁâπÊÆäË¶ÅÊ±Ç'}
                                </Text>
                            )}
                        </div>
                    </Space>
                </div>

                {/* Action Buttons */}
                <Space>
                    {editMode ? (
                        <>
                            <Button type="primary" onClick={handleSaveParameters}>
                                ‰øùÂ≠òÂèÇÊï∞
                            </Button>
                            <Button onClick={() => setEditMode(false)}>
                                ÂèñÊ∂à
                            </Button>
                        </>
                    ) : (
                        <Button
                            icon={<EditOutlined />}
                            onClick={() => setEditMode(true)}
                        >
                            ÁºñËæëÂèÇÊï∞
                        </Button>
                    )}

                    {!isActiveStreaming ? (
                        <Button
                            type="primary"
                            icon={<PlayCircleOutlined />}
                            onClick={handleStartGeneration}
                            disabled={editMode}
                        >
                            ÂºÄÂßãÁîüÊàêÂâßÈõÜ
                        </Button>
                    ) : (
                        <Button
                            type="primary"
                            danger
                            icon={<StopOutlined />}
                            onClick={handleStopGeneration}
                        >
                            ÂÅúÊ≠¢ÁîüÊàê
                        </Button>
                    )}

                    {episodes.length > 0 && (
                        <Button
                            icon={<ExportOutlined />}
                            onClick={handleExport}
                        >
                            ÂØºÂá∫ÂâßÈõÜ
                        </Button>
                    )}
                </Space>
            </Card>

            {/* Generation Progress */}
            {(isActiveStreaming || episodes.length > 0) && (
                <Card title="ÁîüÊàêËøõÂ∫¶" style={{ marginBottom: '20px' }}>
                    <Progress
                        percent={progress}
                        status={isActiveStreaming ? "active" : "normal"}
                        format={() => `${episodes.length}/${expectedEpisodes}`}
                    />
                    {isActiveStreaming && (
                        <div style={{ marginTop: '10px' }}>
                            <Text type="secondary">Ê≠£Âú®ÁîüÊàêÂâßÈõÜÂÜÖÂÆπ...</Text>
                        </div>
                    )}
                    {isStreaming && !isActiveStreaming && (
                        <div style={{ marginTop: '10px' }}>
                            <Text type="secondary">Ê≠£Âú®ÈáçÊñ∞ËøûÊé•Âà∞ÁîüÊàê‰ºöËØù...</Text>
                        </div>
                    )}
                </Card>
            )}

            {/* Episodes List */}
            {episodes.length > 0 && (
                <Card title={`Â∑≤ÁîüÊàêÂâßÈõÜ (${episodes.length}ÈõÜ)`}>
                    <List
                        dataSource={episodes}
                        renderItem={(episode, index) => (
                            <List.Item
                                key={episode.episodeNumber}
                                style={{
                                    backgroundColor: selectedEpisode?.episodeNumber === episode.episodeNumber ? '#f6ffed' : undefined,
                                    borderRadius: selectedEpisode?.episodeNumber === episode.episodeNumber ? '4px' : undefined,
                                    padding: '12px',
                                    margin: '4px 0'
                                }}
                            >
                                <div style={{ width: '100%' }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}>
                                        <Text strong>Á¨¨{episode.episodeNumber}ÈõÜ: {episode.title}</Text>
                                        {isActiveStreaming && index === episodes.length - 1 && (
                                            <Tag color="processing">Ê≠£Âú®ÁîüÊàê</Tag>
                                        )}
                                    </div>
                                    
                                    {/* Episode Summary */}
                                    <div style={{ marginBottom: '12px' }}>
                                        <Paragraph ellipsis={{ rows: 2, expandable: true }}>
                                            {episode.briefSummary}
                                        </Paragraph>
                                    </div>

                                    {/* Key Events */}
                                    {episode.keyEvents && episode.keyEvents.length > 0 && (
                                        <div style={{ marginBottom: '12px' }}>
                                            <Text strong style={{ color: '#1890ff', fontSize: '12px' }}>
                                                üìã ÂÖ≥ÈîÆ‰∫ã‰ª∂:
                                            </Text>
                                            <ul style={{ margin: '4px 0 0 16px', padding: 0 }}>
                                                {episode.keyEvents.map((event, eventIndex) => (
                                                    <li key={eventIndex} style={{ fontSize: '12px', color: '#666', marginBottom: '2px' }}>
                                                        {event}
                                                    </li>
                                                ))}
                                            </ul>
                                        </div>
                                    )}

                                    {/* üî• NEW: Emotion Developments */}
                                    {episode.emotionDevelopments && episode.emotionDevelopments.length > 0 && (
                                        <div style={{ marginBottom: '12px' }}>
                                            <Text strong style={{ color: '#52c41a', fontSize: '12px' }}>
                                                üíö ÊÉÖÊÑüÂèëÂ±ï:
                                            </Text>
                                            <div style={{ marginTop: '4px' }}>
                                                {episode.emotionDevelopments.map((dev, devIndex) => (
                                                    <div key={devIndex} style={{ 
                                                        backgroundColor: '#0a2000', 
                                                        border: '1px solid #237a00',
                                                        borderRadius: '4px',
                                                        padding: '8px',
                                                        marginBottom: '4px'
                                                    }}>
                                                        <div style={{ fontSize: '11px', color: '#52c41a', marginBottom: '2px' }}>
                                                            ËßíËâ≤: {dev.characters.join(', ')}
                                                        </div>
                                                        <div style={{ fontSize: '12px', color: '#d9d9d9' }}>
                                                            {dev.content}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    {/* üî• NEW: Relationship Developments */}
                                    {episode.relationshipDevelopments && episode.relationshipDevelopments.length > 0 && (
                                        <div style={{ marginBottom: '12px' }}>
                                            <Text strong style={{ color: '#1890ff', fontSize: '12px' }}>
                                                üíô ÂÖ≥Á≥ªÂèëÂ±ï:
                                            </Text>
                                            <div style={{ marginTop: '4px' }}>
                                                {episode.relationshipDevelopments.map((dev, devIndex) => (
                                                    <div key={devIndex} style={{ 
                                                        backgroundColor: '#001529', 
                                                        border: '1px solid #1890ff',
                                                        borderRadius: '4px',
                                                        padding: '8px',
                                                        marginBottom: '4px'
                                                    }}>
                                                        <div style={{ fontSize: '11px', color: '#1890ff', marginBottom: '2px' }}>
                                                            ËßíËâ≤: {dev.characters.join(', ')}
                                                        </div>
                                                        <div style={{ fontSize: '12px', color: '#d9d9d9' }}>
                                                            {dev.content}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    {/* End Hook */}
                                    {episode.hooks && (
                                        <div style={{ marginTop: '8px' }}>
                                            <Text strong style={{ color: '#ff7a45', fontSize: '12px' }}>
                                                üé¨ ÁªìÂ∞æÊÇ¨Âøµ:
                                            </Text>
                                            <div style={{ fontSize: '12px', color: '#888', fontStyle: 'italic', marginTop: '2px' }}>
                                                {episode.hooks}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </List.Item>
                        )}
                    />
                </Card>
            )}

            {/* Export Modal */}
            <OutlineExportModal
                visible={isExportModalVisible}
                onClose={() => setIsExportModalVisible(false)}
                exportText={exportText}
                title="ÂâßÈõÜÂ§ßÁ∫≤ÂØºÂá∫"
            />
        </div>
    );
}; 